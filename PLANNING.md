# PLANNING.md

## Overview

This document provides structure and guidance for managing and interpreting ESP-IDF-based projects in CLion. It is intended for use by developers and tools (such as the Windsurf plugin) to assist with automation, project understanding, and build integration.

## Project Type

- **Project Type**: ESP-IDF (Espressif IoT Development Framework)
- **Primary Language**: C / C++
- **IDE**: JetBrains CLion (CMake-based)
- **Build System**: CMake + Ninja
- **Target Microcontroller**: ESP32 / ESP32-S2 / ESP32-S3 / ESP32-C3 (specify in `sdkconfig`)

## Directory Structure

```
project_root/
├── CMakeLists.txt               # Root CMake file
├── main/
│   ├── CMakeLists.txt           # Main application CMake file
│   └── main.c / main.cpp        # Application entry point
├── components/                  # Optional: custom components
│   └── my_component/
│       ├── CMakeLists.txt
│       └── my_component.c
├── sdkconfig                    # ESP-IDF configuration file
├── sdkconfig.defaults           # Default configuration settings
├── build/                       # (Ignored) Generated by build system
└── .idea/                       # CLion project settings
```

## Build and Flash

### Commands

| Task      | Command                          |
| --------- | -------------------------------- |
| Configure | `idf.py reconfigure`             |
| Build     | `idf.py build`                   |
| Flash     | `idf.py -p /dev/ttyUSB0 flash`   |
| Monitor   | `idf.py -p /dev/ttyUSB0 monitor` |

CLion uses a bundled CMake that can coexist with `idf.py`, but it’s recommended to use `idf.py` for consistency with ESP-IDF's tooling and environment setup.

## Toolchain Configuration

- CLion should use the ESP-IDF CMake toolchain.
- Environment setup (done via `export.sh`, `export.bat`, or `export.ps1`) must be sourced before launching CLion.

Example (Linux):

```bash
. $IDF_PATH/export.sh
clion .
```

## Configuration Guidance for Windsurf Plugin

### Detect Project Root

- Look for a top-level `CMakeLists.txt` with:
  
  ```cmake
  include($ENV{IDF_PATH}/tools/cmake/project.cmake)
  project(my_app)
  ```

### Recognize SDK and Board Configuration

- Parse `sdkconfig` or `sdkconfig.defaults` for:
  - `CONFIG_IDF_TARGET`
  - Flash size, partition table, bootloader mode, etc.

### Component Dependencies

- Recursively inspect `components/` and `main/` for additional `CMakeLists.txt` files.
- Use `idf.py build` to resolve full dependency tree.

### Supported Workflows

Windsurf should support:

- Regenerating `sdkconfig`
- Running menuconfig (`idf.py menuconfig`)
- Triggering a rebuild
- Flash + monitor workflows
- Switching targets (via `CONFIG_IDF_TARGET`)

## Customization Points

- `main/CMakeLists.txt`: Define sources, includes, and compile options.
- `components/*/CMakeLists.txt`: Add reusable components.
- `sdkconfig.defaults`: Version-controlled default settings for reproducibility.

## Best Practices

- Avoid modifying `sdkconfig` directly; use `idf.py menuconfig`.
- Track `sdkconfig.defaults` in version control for reproducibility.
- Use `components/` for shared logic or drivers.
- Enable `CCACHE` in CLion for faster rebuilds.

## Tooling Expectations

Windsurf and other tools should:

- Validate ESP-IDF environment is initialized (`IDF_PATH` set, Python venv active).
- Detect board target and key configs from `sdkconfig`.
- Identify and optionally run `idf.py`-based workflows.
- Support integration with CLion run/debug configurations.
